import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime, timedelta
import warnings
warnings.filterwarnings('ignore')

# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤
from statsmodels.tsa.arima.model import ARIMA
from statsmodels.tsa.stattools import adfuller
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf
from statsmodels.tsa.seasonal import seasonal_decompose
from sklearn.metrics import mean_squared_error, mean_absolute_error
import requests
from bs4 import BeautifulSoup
import yfinance as yf
import time

class SamsungStockPredictor:
    def __init__(self):
        self.samsung_data = None
        self.samsung_pref_data = None
        self.model = None
        self.forecast_result = None
        
    def get_korean_stock_data(self, symbol, period='2y'):
        """
        í•œêµ­ ì£¼ì‹ ë°ì´í„°ë¥¼ ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        ì‚¼ì„±ì „ì: 005930.KS, ì‚¼ì„±ì „ììš°: 005935.KS
        """
        try:
            # í•œêµ­ ì£¼ì‹ ì‹¬ë³¼ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            if symbol == '005930':
                ticker = '005930.KS'
            elif symbol == '005935':
                ticker = '005935.KS'
            else:
                ticker = f"{symbol}.KS"
            
            stock = yf.Ticker(ticker)
            data = stock.history(period=period)
            
            # í•œêµ­ ì‹œê°„ëŒ€ ì„¤ì • ë° ì»¬ëŸ¼ëª… í•œêµ­ì–´ë¡œ ë³€ê²½
            data.index = pd.to_datetime(data.index)
            data.columns = ['ì‹œê°€', 'ê³ ê°€', 'ì €ê°€', 'ì¢…ê°€', 'ê±°ë˜ëŸ‰', 'ë°°ë‹¹ê¸ˆ', 'ì£¼ì‹ë¶„í• ']
            
            return data
        except Exception as e:
            print(f"ë°ì´í„° ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return None
    
    def create_weekly_data(self, daily_data):
        """ì¼ë´‰ ë°ì´í„°ë¥¼ ì£¼ë´‰ ë°ì´í„°ë¡œ ë³€í™˜"""
        weekly_data = daily_data.resample('W').agg({
            'ì‹œê°€': 'first',
            'ê³ ê°€': 'max',
            'ì €ê°€': 'min',
            'ì¢…ê°€': 'last',
            'ê±°ë˜ëŸ‰': 'sum'
        }).dropna()
        
        return weekly_data
    
    def load_data(self):
        """ì‚¼ì„±ì „ìì™€ ì‚¼ì„±ì „ììš° ë°ì´í„° ë¡œë“œ"""
        print("ğŸ“Š ì‚¼ì„±ì „ì ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...")
        
        # ì‚¼ì„±ì „ì (005930)
        self.samsung_data = self.get_korean_stock_data('005930', period='3y')
        
        # ì‚¼ì„±ì „ììš° (005935)
        self.samsung_pref_data = self.get_korean_stock_data('005935', period='3y')
        
        if self.samsung_data is not None and self.samsung_pref_data is not None:
            # ì£¼ë´‰ ë°ì´í„°ë¡œ ë³€í™˜
            self.samsung_weekly = self.create_weekly_data(self.samsung_data)
            self.samsung_pref_weekly = self.create_weekly_data(self.samsung_pref_data)
            
            print(f"âœ… ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!")
            print(f"ì‚¼ì„±ì „ì ë°ì´í„° ê¸°ê°„: {self.samsung_weekly.index.min()} ~ {self.samsung_weekly.index.max()}")
            print(f"ì‚¼ì„±ì „ììš° ë°ì´í„° ê¸°ê°„: {self.samsung_pref_weekly.index.min()} ~ {self.samsung_pref_weekly.index.max()}")
            
            return True
        else:
            print("âŒ ë°ì´í„° ìˆ˜ì§‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
            return False
    
    def analyze_stationarity(self, series, title=""):
        """ì‹œê³„ì—´ ë°ì´í„°ì˜ ì •ìƒì„± ê²€ì •"""
        print(f"\n=== {title} ì •ìƒì„± ê²€ì • ===")
        
        # ADF í…ŒìŠ¤íŠ¸
        adf_result = adfuller(series.dropna())
        print(f"ADF í†µê³„ëŸ‰: {adf_result[0]:.4f}")
        print(f"p-value: {adf_result[1]:.4f}")
        print(f"ì„ê³„ê°’: {adf_result[4]}")
        
        if adf_result[1] <= 0.05:
            print("âœ… ì •ìƒ ì‹œê³„ì—´ì…ë‹ˆë‹¤.")
            return True
        else:
            print("âŒ ë¹„ì •ìƒ ì‹œê³„ì—´ì…ë‹ˆë‹¤. ì°¨ë¶„ì´ í•„ìš”í•©ë‹ˆë‹¤.")
            return False
    
    def find_optimal_arima_params(self, series, max_p=5, max_d=2, max_q=5):
        """ìµœì ì˜ ARIMA íŒŒë¼ë¯¸í„° ì°¾ê¸° (AIC ê¸°ì¤€)"""
        print("\nğŸ” ìµœì  ARIMA íŒŒë¼ë¯¸í„° íƒìƒ‰ ì¤‘...")
        
        best_aic = float('inf')
        best_params = None
        
        for p in range(max_p + 1):
            for d in range(max_d + 1):
                for q in range(max_q + 1):
                    try:
                        model = ARIMA(series, order=(p, d, q))
                        fitted_model = model.fit()
                        
                        if fitted_model.aic < best_aic:
                            best_aic = fitted_model.aic
                            best_params = (p, d, q)
                            
                    except:
                        continue
        
        print(f"âœ… ìµœì  íŒŒë¼ë¯¸í„°: ARIMA{best_params}, AIC: {best_aic:.2f}")
        return best_params
    
    def create_arima_model(self, target_stock='samsung'):
        """ARIMA ëª¨ë¸ ìƒì„± ë° í›ˆë ¨"""
        if target_stock == 'samsung':
            data = self.samsung_weekly['ì¢…ê°€']
            title = "ì‚¼ì„±ì „ì"
        else:
            data = self.samsung_pref_weekly['ì¢…ê°€']
            title = "ì‚¼ì„±ì „ììš°"
        
        print(f"\nğŸ¤– {title} ARIMA ëª¨ë¸ ìƒì„± ì¤‘...")
        
        # ì •ìƒì„± ê²€ì •
        is_stationary = self.analyze_stationarity(data, title)
        
        # ìµœì  íŒŒë¼ë¯¸í„° íƒìƒ‰
        optimal_params = self.find_optimal_arima_params(data)
        
        # ëª¨ë¸ í›ˆë ¨
        self.model = ARIMA(data, order=optimal_params)
        self.fitted_model = self.model.fit()
        
        print(f"âœ… {title} ARIMA ëª¨ë¸ ìƒì„± ì™„ë£Œ!")
        print(self.fitted_model.summary())
        
        return self.fitted_model
    
    def predict_future_prices(self, steps=12):
        """ë¯¸ë˜ ì£¼ê°€ ì˜ˆì¸¡ (ê¸°ë³¸ 12ì£¼)"""
        if self.fitted_model is None:
            print("âŒ ëª¨ë¸ì´ í›ˆë ¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            return None
        
        print(f"\nğŸ”® í–¥í›„ {steps}ì£¼ ì£¼ê°€ ì˜ˆì¸¡ ì¤‘...")
        
        # ì˜ˆì¸¡ ìˆ˜í–‰
        forecast = self.fitted_model.forecast(steps=steps)
        forecast_ci = self.fitted_model.get_forecast(steps=steps).conf_int()
        
        # ì˜ˆì¸¡ ê²°ê³¼ ì •ë¦¬
        future_dates = pd.date_range(
            start=self.samsung_weekly.index[-1] + timedelta(weeks=1),
            periods=steps,
            freq='W'
        )
        
        self.forecast_result = pd.DataFrame({
            'ì˜ˆì¸¡ê°€': forecast,
            'í•˜í•œ': forecast_ci.iloc[:, 0],
            'ìƒí•œ': forecast_ci.iloc[:, 1]
        }, index=future_dates)
        
        print("âœ… ì˜ˆì¸¡ ì™„ë£Œ!")
        print(self.forecast_result.head())
        
        return self.forecast_result
    
    def visualize_results(self):
        """ê²°ê³¼ ì‹œê°í™”"""
        if self.forecast_result is None:
            print("âŒ ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        plt.figure(figsize=(15, 10))
        
        # ì „ì²´ ê·¸ë˜í”„
        plt.subplot(2, 2, 1)
        plt.plot(self.samsung_weekly.index, self.samsung_weekly['ì¢…ê°€'], 
                label='ì‚¼ì„±ì „ì ì‹¤ì œ ì£¼ê°€', color='blue', linewidth=2)
        plt.plot(self.samsung_pref_weekly.index, self.samsung_pref_weekly['ì¢…ê°€'], 
                label='ì‚¼ì„±ì „ììš° ì‹¤ì œ ì£¼ê°€', color='green', linewidth=2)
        plt.title('ì‚¼ì„±ì „ì vs ì‚¼ì„±ì „ììš° ì£¼ê°€ ë¹„êµ', fontsize=14, fontweight='bold')
        plt.legend()
        plt.grid(True, alpha=0.3)
        
        # ì˜ˆì¸¡ ê²°ê³¼
        plt.subplot(2, 2, 2)
        # ìµœê·¼ 6ê°œì›” ë°ì´í„°
        recent_data = self.samsung_weekly.tail(24)
        plt.plot(recent_data.index, recent_data['ì¢…ê°€'], 
                label='ì‹¤ì œ ì£¼ê°€', color='blue', linewidth=2)
        plt.plot(self.forecast_result.index, self.forecast_result['ì˜ˆì¸¡ê°€'], 
                label='ì˜ˆì¸¡ ì£¼ê°€', color='red', linewidth=2)
        plt.fill_between(self.forecast_result.index, 
                        self.forecast_result['í•˜í•œ'], 
                        self.forecast_result['ìƒí•œ'], 
                        alpha=0.3, color='red', label='ì˜ˆì¸¡ êµ¬ê°„')
        plt.title('ì‚¼ì„±ì „ì ì£¼ê°€ ì˜ˆì¸¡ ê²°ê³¼', fontsize=14, fontweight='bold')
        plt.legend()
        plt.grid(True, alpha=0.3)
        
        # ê±°ë˜ëŸ‰ ë¶„ì„
        plt.subplot(2, 2, 3)
        plt.plot(self.samsung_weekly.index, self.samsung_weekly['ê±°ë˜ëŸ‰'], 
                color='orange', linewidth=1, alpha=0.7)
        plt.title('ì‚¼ì„±ì „ì ê±°ë˜ëŸ‰ ì¶”ì´', fontsize=14, fontweight='bold')
        plt.grid(True, alpha=0.3)
        
        # ê°€ê²© ë¶„í¬
        plt.subplot(2, 2, 4)
        plt.hist(self.samsung_weekly['ì¢…ê°€'], bins=30, alpha=0.7, color='skyblue')
        plt.axvline(self.samsung_weekly['ì¢…ê°€'].mean(), color='red', 
                   linestyle='--', label=f'í‰ê· : {self.samsung_weekly["ì¢…ê°€"].mean():.0f}ì›')
        plt.title('ì‚¼ì„±ì „ì ì£¼ê°€ ë¶„í¬', fontsize=14, fontweight='bold')
        plt.legend()
        plt.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.show()
    
    def generate_investment_insight(self):
        """íˆ¬ì ì¸ì‚¬ì´íŠ¸ ìƒì„±"""
        if self.forecast_result is None:
            return "ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."
        
        current_price = self.samsung_weekly['ì¢…ê°€'].iloc[-1]
        predicted_price = self.forecast_result['ì˜ˆì¸¡ê°€'].iloc[-1]
        price_change = ((predicted_price - current_price) / current_price) * 100
        
        # ê±°ë˜ëŸ‰ íŠ¸ë Œë“œ ë¶„ì„
        recent_volume = self.samsung_weekly['ê±°ë˜ëŸ‰'].tail(4).mean()
        historical_volume = self.samsung_weekly['ê±°ë˜ëŸ‰'].mean()
        volume_change = ((recent_volume - historical_volume) / historical_volume) * 100
        
        insight = f"""
        ğŸ¯ ì‚¼ì„±ì „ì íˆ¬ì ì¸ì‚¬ì´íŠ¸ (ARIMA ê¸°ë°˜ ë¶„ì„)
        
        ğŸ“Š í˜„ì¬ ìƒí™©:
        - í˜„ì¬ ì£¼ê°€: {current_price:,.0f}ì›
        - 12ì£¼ í›„ ì˜ˆìƒ ì£¼ê°€: {predicted_price:,.0f}ì›
        - ì˜ˆìƒ ìˆ˜ìµë¥ : {price_change:+.1f}%
        
        ğŸ“ˆ ê±°ë˜ëŸ‰ ë¶„ì„:
        - ìµœê·¼ í‰ê·  ê±°ë˜ëŸ‰: {recent_volume:,.0f}ì£¼
        - ì „ì²´ í‰ê·  ê±°ë˜ëŸ‰: {historical_volume:,.0f}ì£¼
        - ê±°ë˜ëŸ‰ ë³€í™”: {volume_change:+.1f}%
        
        ğŸ’¡ íˆ¬ì ê´€ì :
        {"ğŸ“ˆ ìƒìŠ¹ ì¶”ì„¸ê°€ ì˜ˆìƒë©ë‹ˆë‹¤." if price_change > 0 else "ğŸ“‰ í•˜ë½ ì¶”ì„¸ê°€ ì˜ˆìƒë©ë‹ˆë‹¤."}
        {"ğŸ“Š ê±°ë˜ëŸ‰ì´ ì¦ê°€í•˜ê³  ìˆì–´ ê´€ì‹¬ì´ ë†’ì•„ì§€ê³  ìˆìŠµë‹ˆë‹¤." if volume_change > 0 else "ğŸ“Š ê±°ë˜ëŸ‰ì´ ê°ì†Œí•˜ê³  ìˆì–´ ê´€ì‹¬ì´ ì¤„ì–´ë“¤ê³  ìˆìŠµë‹ˆë‹¤."}
        
        âš ï¸ ì£¼ì˜ì‚¬í•­:
        - ì´ ì˜ˆì¸¡ì€ ê³¼ê±° ë°ì´í„° ê¸°ë°˜ í†µê³„ ëª¨ë¸ì…ë‹ˆë‹¤
        - ì‹¤ì œ íˆ¬ì ê²°ì • ì‹œì—ëŠ” ì¶”ê°€ì ì¸ í€ë”ë©˜í„¸ ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤
        - ì‹œì¥ ìƒí™©, ì •ì¹˜ì  ìš”ì¸, ê¸€ë¡œë²Œ ê²½ì œ ìƒí™© ë“±ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤
        """
        
        return insight

def main():
    # ì˜ˆì¸¡ ëª¨ë¸ ì‹¤í–‰
    predictor = SamsungStockPredictor()
    
    # 1. ë°ì´í„° ë¡œë“œ
    if not predictor.load_data():
        return
    
    # 2. ARIMA ëª¨ë¸ ìƒì„±
    model = predictor.create_arima_model(target_stock='samsung')
    
    # 3. ë¯¸ë˜ ì˜ˆì¸¡
    forecast = predictor.predict_future_prices(steps=12)
    
    # 4. ê²°ê³¼ ì‹œê°í™”
    predictor.visualize_results()
    
    # 5. íˆ¬ì ì¸ì‚¬ì´íŠ¸ ì¶œë ¥
    insight = predictor.generate_investment_insight()
    print(insight)

if __name__ == "__main__":
    main()
